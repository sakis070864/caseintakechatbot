<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legal Intake Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- UI & Icon Components ---
        const SendIcon = () => (<svg viewBox="0 0 24 24" className="w-6 h-6" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" /></svg>);
        const BotIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-7 h-7 text-white"><path d="M4.75 2.75C4.75 2.19772 5.19772 1.75 5.75 1.75H18.25C18.8023 1.75 19.25 2.19772 19.25 2.75V10.25C19.25 10.8023 18.8023 11.25 18.25 11.25H5.75C5.19772 11.25 4.75 10.8023 4.75 10.25V2.75ZM5.75 21.25C5.19772 21.25 4.75 20.8023 4.75 20.25V12.75C4.75 12.1977 5.19772 11.75 5.75 11.75H18.25C18.8023 11.75 19.25 12.1977 19.25 12.75V20.25C19.25 20.8023 18.8023 21.25 18.25 21.25H5.75Z" /><path d="M9.25 6.5C9.25 7.05228 8.80228 7.5 8.25 7.5C7.69772 7.5 7.25 7.05228 7.25 6.5C7.25 5.94772 7.69772 5.5 8.25 5.5C8.80228 5.5 9.25 5.94772 9.25 6.5Z" /><path d="M16.25 6.5C16.25 7.05228 15.8023 7.5 15.25 7.5C14.6977 7.5 14.25 7.05228 14.25 6.5C14.25 5.94772 14.6977 5.5 15.25 5.5C15.8023 5.5 16.25 5.94772 16.25 6.5Z" /><path d="M13.25 16C13.25 16.4142 12.9142 16.75 12.5 16.75H11.5C11.0858 16.75 10.75 16.4142 10.75 16C10.75 15.5858 11.0858 15.25 11.5 15.25H12.5C12.9142 15.25 13.25 15.5858 13.25 16Z" /></svg>);
        const UserIcon = () => (<svg viewBox="0 0 24 24" className="w-7 h-7 text-gray-600" fill="currentColor"><path fillRule="evenodd" clipRule="evenodd" d="M12 20.25c-4.274 0-8.25-3.476-8.25-7.75S7.726 4.75 12 4.75s8.25 3.476 8.25 7.75-3.976 7.75-8.25 7.75Zm0 1.5A9.75 9.75 0 1 0 12 2.75a9.75 9.75 0 0 0 0 17.25Z" /><path fillRule="evenodd" clipRule="evenodd" d="M12 14.25a3.75 3.75 0 1 0 0-7.5 3.75 3.75 0 0 0 0 7.5Zm0 1.5a5.25 5.25 0 1 0 0-10.5 5.25 5.25 0 0 0 0 10.5Z" /></svg>);

        const ChatMessage = ({ message }) => {
          const isBot = message.sender === 'bot';
          const renderText = (text) => {
            return text.split('\n').map((line, i) => <p key={i}>{line.split(/(\*\*.*?\*\*)/g).map((part, j) => part.startsWith('**') ? <strong key={j}>{part.slice(2, -2)}</strong> : part)}</p>);
          };
          return (<div className={`flex items-start gap-3 my-4 ${isBot ? '' : 'flex-row-reverse'}`}><div className={`flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center ${isBot ? 'bg-slate-800' : 'bg-gray-200'}`}>{isBot ? <BotIcon /> : <UserIcon />}</div><div className={`max-w-2xl p-4 rounded-xl shadow-sm ${isBot ? 'bg-gray-100 text-gray-800 rounded-bl-none' : 'bg-blue-600 text-white rounded-br-none'}`}><div className="prose prose-sm max-w-none whitespace-pre-wrap">{renderText(message.text)}</div></div></div>);
        };

        const ContactForm = ({ onContactSubmit }) => {
            const [name, setName] = useState('');
            const [email, setEmail] = useState('');
            const [phone, setPhone] = useState('');
            const [formError, setFormError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!name.trim() || !email.trim()) {
                    setFormError('Full Name and Email are required.');
                    return;
                }
                onContactSubmit({ name, email, phone });
            };

            return (
                <div className="p-4 bg-white rounded-lg shadow-md max-w-md mx-auto my-4 border border-gray-200">
                    <h2 className="text-lg font-semibold text-gray-800 mb-3">Client Information</h2>
                    <p className="text-sm text-gray-500 mb-4">Please provide your contact details to begin.</p>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label htmlFor="name" className="block text-sm font-medium text-gray-700">Full Name *</label>
                            <input type="text" id="name" value={name} onChange={(e) => setName(e.target.value)} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required />
                        </div>
                        <div>
                            <label htmlFor="email" className="block text-sm font-medium text-gray-700">Email Address *</label>
                            <input type="email" id="email" value={email} onChange={(e) => setEmail(e.target.value)} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required />
                        </div>
                        <div>
                            <label htmlFor="phone" className="block text-sm font-medium text-gray-700">Telephone (Optional)</label>
                            <input type="tel" id="phone" value={phone} onChange={(e) => setPhone(e.target.value)} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
                        </div>
                        {formError && <p className="text-sm text-red-600">{formError}</p>}
                        <button type="submit" className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Start Intake
                        </button>
                    </form>
                </div>
            );
        };

        function App() {
          const [userInput, setUserInput] = useState('');
          const [messages, setMessages] = useState([]);
          const [isLoading, setIsLoading] = useState(false);
          const [appState, setAppState] = useState('collecting_contact');
          const [clientInfo, setClientInfo] = useState(null);
          
          const [interviewPlan, setInterviewPlan] = useState(null);
          const [interviewData, setInterviewData] = useState([]);
          const [currentCategoryIndex, setCurrentCategoryIndex] = useState(0);
          const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);

          const [initialCaseDescription, setInitialCaseDescription] = useState('');
          const [reportFailed, setReportFailed] = useState(false);

          const chatEndRef = useRef(null);
          const lastId = useRef(0);

          const getUniqueId = () => { lastId.current += 1; return lastId.current; };
          useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]);

          const callBackendAPI = async (prompt, jsonMode = false) => {
            const API_ENDPOINT = 'https://caseintake.onrender.com/api/gemini'; 
            const response = await fetch(API_ENDPOINT, { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify({ prompt, jsonMode })
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'API Error');
            return data.candidates[0].content.parts[0].text.trim();
          };

          const saveReportToDB = async (reportContent) => {
            const API_ENDPOINT = 'https://caseintake.onrender.com/api/save-report';
            const response = await fetch(API_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    clientName: clientInfo.name,
                    clientEmail: clientInfo.email,
                    clientPhone: clientInfo.phone,
                    reportContent
                })
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to save report');
            }
          };

          const handleContactSubmit = (info) => {
            setClientInfo(info);
            setAppState('initial_prompt');
            setMessages([{ id: getUniqueId(), text: `Thank you, ${info.name}. To start, please describe your situation below.`, sender: 'bot' }]);
          };
          
          const generateReport = async () => {
            setIsLoading(true); setReportFailed(false); setAppState('generating_report');
            setMessages(prev => [...prev, { id: getUniqueId(), text: "Thank you. Compiling your case summary report...", sender: 'bot' }]);
            const currentDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            const reportPrompt = `
              You are a senior paralegal tasked with creating a professional case intake report.
              The report should be structured like a professional legal memo. Start with a header containing TO, FROM, DATE, and RE fields.
              The DATE must be today's date: ${currentDate}.
              After the header, synthesize ALL of the following information into a clear, structured, and professional report that a lawyer can use for an initial case evaluation.
              The report should include the following sections, clearly marked with bold headings:
              1.  **Case Summary:** A brief, one-paragraph overview of the client's core problem.
              2.  **Client's Initial Statement:** The original, unedited description provided by the client.
              3.  **Intake Interview Q&A:** A list of the questions asked and the client's corresponding answers.
              4.  **Key Facts & Timeline:** A bulleted list of the most important facts, dates, and figures extracted from the entire conversation.
              5.  **Potential Legal Issues:** A brief, high-level identification of potential areas of law that may be relevant (e.g., "Contract Law," "Corporate Law," "Potential Fraud"). Do not provide legal advice.
              Here is the information to use:
              ---
              **CLIENT INFORMATION:**
              Name: ${clientInfo.name}
              Email: ${clientInfo.email}
              Phone: ${clientInfo.phone || 'Not provided'}
              ---
              **INITIAL CASE DESCRIPTION:**
              "${initialCaseDescription}"
              ---
              **INTERVIEW QUESTIONS & ANSWERS:**
              ${interviewData.map(item => `Q: ${item.question}\nA: ${item.answer}`).join('\n\n')}
              ---
              Now, please generate the complete case intake report, starting with the memo header.
            `;
            try {
                const reportText = await callBackendAPI(reportPrompt);
                await saveReportToDB(reportText);
                setMessages(prev => [...prev, { id: getUniqueId(), text: reportText, sender: 'bot' }, { id: getUniqueId(), text: "A copy of this report has been saved and sent to the attorney for review. Thank you for your time.", sender: 'bot' }]);
                setAppState('done');
            } catch (error) {
                setMessages(prev => [...prev, { id: getUniqueId(), text: `Error generating or saving report: ${error.message}. An administrator has been notified. Please try again.`, sender: 'bot' }]);
                setReportFailed(true); setAppState('interview_complete');
            } finally {
                setIsLoading(false);
            }
          };

          const handleSendMessage = async () => {
            if (!userInput.trim() || isLoading) return;
            const currentUserInput = userInput;
            setMessages(prev => [...prev, { id: getUniqueId(), text: currentUserInput, sender: 'user' }]);
            setUserInput('');
            setIsLoading(true);

            try {
                if (appState === 'initial_prompt') {
                    setInitialCaseDescription(currentUserInput);
                    const prompt = `
                        You are an experienced and empathetic lawyer. Your goal is to conduct a thorough initial client intake.

                        Scenario:
                        A potential new client has contacted you with the following case. You are now preparing the questions you will ask them during the first consultation.

                        Client's Case Description:
                        ${currentUserInput}

                        Task:
                        Based on the client's case description above, generate a comprehensive intake plan. The questions should be designed to gather all critical facts, understand the client's objectives, identify the strengths and weaknesses of the case, and determine the best legal strategy.

                        Required Structure:
                        Your response MUST be a valid JSON object with the following structure: 
                        {
                          "introduction": "A brief introductory statement to welcome the client and explain the purpose of the meeting.",
                          "categories": [
                            {
                              "title": "Category Name (e.g., Background Information)",
                              "questions": ["A list of open-ended questions for this category."]
                            }
                          ],
                          "conclusion": "A brief closing statement explaining what the client can expect after the consultation."
                        }
                        Do not include any text outside of the JSON object.
                    `;
                    
                    const responseText = await callBackendAPI(prompt, true);
                    
                    try {
                        const plan = JSON.parse(responseText);
                        if (plan.introduction && plan.categories && plan.conclusion) {
                            setInterviewPlan(plan);
                            setMessages(prev => [...prev, { id: getUniqueId(), text: plan.introduction, sender: 'bot' }]);
                            setAppState('asking_questions');
                            setCurrentCategoryIndex(0);
                            setCurrentQuestionIndex(0);
                            setMessages(prev => [...prev, { id: getUniqueId(), text: `Let's start with: **${plan.categories[0].title}**`, sender: 'bot' }]);
                            setMessages(prev => [...prev, { id: getUniqueId(), text: plan.categories[0].questions[0], sender: 'bot' }]);
                        } else {
                            throw new Error("Invalid plan structure from AI.");
                        }
                    } catch (e) {
                        console.error("Failed to parse interview plan:", e);
                        setMessages(prev => [...prev, { id: getUniqueId(), text: "I'm having trouble preparing for our conversation. Could you please try describing your situation again?", sender: 'bot' }]);
                    }

                } else if (appState === 'asking_questions') {
                    const currentQuestion = interviewPlan.categories[currentCategoryIndex].questions[currentQuestionIndex];
                    
                    setInterviewData(prev => [...prev, { question: currentQuestion, answer: currentUserInput }]);

                    let nextQuestionIndex = currentQuestionIndex + 1;
                    let nextCategoryIndex = currentCategoryIndex;

                    if (nextQuestionIndex >= interviewPlan.categories[nextCategoryIndex].questions.length) {
                        nextQuestionIndex = 0;
                        nextCategoryIndex += 1;
                    }

                    setCurrentQuestionIndex(nextQuestionIndex);
                    setCurrentCategoryIndex(nextCategoryIndex);

                    if (nextCategoryIndex < interviewPlan.categories.length) {
                        if (nextQuestionIndex === 0) {
                            setMessages(prev => [...prev, { id: getUniqueId(), text: `Great, thank you. Now for the next section: **${interviewPlan.categories[nextCategoryIndex].title}**`, sender: 'bot' }]);
                        }
                        const nextQuestion = interviewPlan.categories[nextCategoryIndex].questions[nextQuestionIndex];
                        setMessages(prev => [...prev, { id: getUniqueId(), text: nextQuestion, sender: 'bot' }]);
                    } else {
                        setMessages(prev => [...prev, { id: getUniqueId(), text: interviewPlan.conclusion, sender: 'bot' }]);
                        setAppState('interview_complete');
                        await generateReport();
                    }
                }
            } catch (error) {
                setMessages(prev => [...prev, { id: getUniqueId(), text: `I'm sorry, I encountered a technical issue. Please try sending your message again. Error: ${error.message}`, sender: 'bot' }]);
            } finally {
                setIsLoading(false);
            }
          };
          
          const getPlaceholderText = () => {
            if (appState === 'collecting_contact') return 'Please fill out the form above.';
            if (appState === 'initial_prompt') return 'Describe your legal case here...';
            if (appState === 'asking_questions') return `Your answer...`;
            return 'The interview is complete.';
          };

          return (
            <div className="flex flex-col h-screen bg-gray-50 font-sans text-gray-800">
              <header className="bg-white shadow-sm p-4 border-b border-gray-200 sticky top-0 z-10">
                <div className="max-w-4xl mx-auto flex justify-center items-center">
                    <h1 className="text-2xl font-semibold text-slate-800">Legal Intake Assistant</h1>
                </div>
              </header>

              <main className="flex-1 overflow-y-auto p-4">
                <div className="max-w-3xl mx-auto">
                  {appState === 'collecting_contact' && <ContactForm onContactSubmit={handleContactSubmit} />}
                  {messages.map(msg => <ChatMessage key={msg.id} message={msg} />)}
                  {isLoading && (<div className="flex items-start gap-3 my-4"><div className="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center bg-slate-800"><BotIcon /></div><div className="max-w-xl p-4 rounded-xl shadow-sm bg-gray-100"><div className="flex items-center space-x-2"><div className="w-2.5 h-2.5 bg-slate-500 rounded-full animate-pulse"></div><div className="w-2.5 h-2.5 bg-slate-500 rounded-full animate-pulse" style={{animationDelay:'0.2s'}}></div><div className="w-2.5 h-2.5 bg-slate-500 rounded-full animate-pulse" style={{animationDelay:'0.4s'}}></div></div></div></div>)}
                  <div ref={chatEndRef} />
                </div>
              </main>

              <footer className="bg-white/80 backdrop-blur-lg p-4 border-t border-gray-200 sticky bottom-0">
                <div className="max-w-3xl mx-auto">
                  {reportFailed ? (<button onClick={generateReport} className="w-full p-3 rounded-lg bg-green-600 text-white font-semibold hover:bg-green-700 transition-colors">Retry Report Generation</button>) : (appState !== 'collecting_contact' && <div className="flex items-center bg-white rounded-xl p-2 shadow-md border border-gray-200"><textarea value={userInput} onChange={(e) => setUserInput(e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); } }} placeholder={getPlaceholderText()} className="flex-1 bg-transparent p-2 border-none focus:outline-none focus:ring-0 resize-none text-base" rows="1" disabled={isLoading || appState === 'done' || appState === 'generating_report'} /><button onClick={handleSendMessage} disabled={isLoading || !userInput.trim() || appState === 'done' || appState === 'generating_report'} className="p-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors duration-200"><SendIcon /></button></div>)}
                </div>
              </footer>
            </div>
          );
        }

        const container = document.getElementById('root');
        
        if (!container._reactRootContainer) {
            const root = ReactDOM.createRoot(container);
            root.render(<App />);
        }
    </script>
</body>
</html>
